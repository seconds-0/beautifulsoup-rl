name: Training Monitor

on:
  schedule:
    # Run every 10 minutes
    - cron: '*/10 * * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: false
        default: 'check'
        type: choice
        options:
          - check        # Just check status
          - provision    # Force provision new instance
          - terminate    # Terminate all training instances

env:
  RUN_ID: bs4-qwen3-8b
  WANDB_PROJECT: beautiful-soup-env
  WANDB_ENTITY: seconds-0-domus-magna-inc
  GPU_TYPE: H100_PCIE
  GPU_COUNT: 2
  MAX_BID: 2.50

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install wandb vastai b2sdk requests

      - name: Run training controller
        env:
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
          VAST_API_KEY: ${{ secrets.VAST_API_KEY }}
          B2_APPLICATION_KEY_ID: ${{ secrets.B2_APPLICATION_KEY_ID }}
          B2_APPLICATION_KEY: ${{ secrets.B2_APPLICATION_KEY }}
          ACTION: ${{ github.event.inputs.action || 'check' }}
        run: |
          python scripts/training_controller.py \
            --run-id "$RUN_ID" \
            --wandb-project "$WANDB_PROJECT" \
            --wandb-entity "$WANDB_ENTITY" \
            --gpu-type "$GPU_TYPE" \
            --gpu-count "$GPU_COUNT" \
            --max-bid "$MAX_BID" \
            --action "$ACTION"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: controller-logs
          path: /tmp/training_controller.log
          retention-days: 7
